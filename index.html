<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Weekly AI Trends & App Radar</title>
  <meta name="description" content="Weekly AI trends, most discussed apps/tools, sentiment drivers, and PM action recommendations." />
  <style>
    :root{
      --bg:#0b0c10;
      --panel:#11131a;
      --panel2:#0e1016;
      --text:#e6e6e6;
      --muted:#b8b8b8;
      --border:#222;
      --border2:#2a2a2a;
      --accent:#a8b3ff;
      --shadow: 0 8px 24px rgba(0,0,0,.22);
      --try:#2ee86a;
      --mon:#ffd84a;
      --ign:#ff5b5b;
    }
    [data-theme="light"]{
      --bg:#f7f7fb;
      --panel:#ffffff;
      --panel2:#f3f4f8;
      --text:#12131a;
      --muted:#5b5f6b;
      --border:#e5e7ee;
      --border2:#d7dae6;
      --accent:#3949ff;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --try:#0aa84a;
      --mon:#b28000;
      --ign:#d81f1f;
    }

    *{ box-sizing: border-box; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0;
      background:var(--bg);
      color:var(--text);
    }
    header{
      padding: 18px 18px 14px;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: color-mix(in srgb, var(--bg) 92%, transparent);
      backdrop-filter: blur(10px);
      z-index: 10;
    }
    h1{ margin: 0 0 6px 0; font-size: 20px; letter-spacing:.2px;}
    h2{ margin: 0; font-size: 16px;}
    h3{ margin: 0; font-size: 13px; color: var(--muted);}
    .sub{ color: var(--muted); font-size: 13px; }
    main{ padding: 18px; max-width: 1150px; margin: 0 auto; }
    .grid{ display:grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 920px){ .grid.two{ grid-template-columns: 1fr 1fr; } }
    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card.soft{ background: var(--panel2); box-shadow:none; }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row.between{ justify-content: space-between; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 10px;
      border: 1px solid var(--border2);
      border-radius: 999px;
      font-size: 12px;
      color: color-mix(in srgb, var(--text) 80%, var(--muted));
      background: color-mix(in srgb, var(--panel) 70%, transparent);
      user-select:none;
    }
    .pill.try{ border-color: color-mix(in srgb, var(--try) 65%, var(--border2)); }
    .pill.mon{ border-color: color-mix(in srgb, var(--mon) 65%, var(--border2)); }
    .pill.ign{ border-color: color-mix(in srgb, var(--ign) 65%, var(--border2)); }
    .score{ font-weight: 800; font-size: 13px; }
    .btn{
      cursor:pointer;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border2);
      background: var(--panel2);
      color: var(--text);
      font-size: 13px;
    }
    .btn.active{ border-color: color-mix(in srgb, var(--accent) 75%, var(--border2)); }
    .btn.ghost{ background: transparent; }
    input, select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border2);
      background: var(--panel2);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }
    input{ width: min(560px, 100%); }
    select{ cursor:pointer; }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration: underline; }
    ul{ margin: 8px 0 0 18px; }
    li{ margin: 3px 0; }
    .muted{ color: var(--muted); }
    .kpi{ display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:8px; margin-top: 10px; }
    .kpi > div{ border: 1px solid var(--border); border-radius: 12px; padding: 10px; background: var(--panel2); }
    .kpi label{ display:block; font-size: 11px; color: var(--muted); margin-bottom: 6px; }
    .kpi strong{ font-size: 16px; }
    .split{ display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 920px){ .split{ grid-template-columns: 1.2fr .8fr; } }
    .hr{ height:1px; background: var(--border); margin: 10px 0; }
    .small{ font-size:12px; color: var(--muted); }
    .danger{ color: var(--ign); }
  </style>
</head>
<body>
  <header>
    <div class="row between">
      <div>
        <h1>Weekly AI Trends & App Radar</h1>
        <div class="sub" id="meta">Loading‚Ä¶</div>
      </div>
      <div class="row">
        <button class="btn ghost" id="themeBtn" title="Toggle theme">üåì Theme</button>
        <a class="btn" id="jsonLink" href="latest.json" target="_blank" rel="noopener">Open JSON</a>
      </div>
    </div>

    <div class="row" style="margin-top: 12px;">
      <input id="q" placeholder="Search apps, drivers, keywords‚Ä¶" />
      <span class="pill" id="counts">‚Äî</span>
    </div>

    <div class="row" style="margin-top: 10px;">
      <button class="btn active" id="tabAll">All</button>
      <button class="btn" id="tabB2B">B2B SaaS</button>
      <button class="btn" id="tabConsumer">Consumer</button>

      <span class="pill">Action</span>
      <select id="actionSel" aria-label="Action filter">
        <option value="all">All</option>
        <option value="TRY">Try</option>
        <option value="MONITOR">Monitor</option>
        <option value="IGNORE">Ignore</option>
      </select>

      <span class="pill">Sort</span>
      <select id="sortSel" aria-label="Sort">
        <option value="buzz">Buzz score</option>
        <option value="fit">PM fit</option>
        <option value="sent">Sentiment net</option>
      </select>

      <span class="pill">Min buzz</span>
      <select id="minBuzzSel" aria-label="Minimum buzz">
        <option value="0">0</option>
        <option value="50">50</option>
        <option value="70" selected>70</option>
        <option value="80">80</option>
        <option value="90">90</option>
      </select>
    </div>
  </header>

  <main>
    <div class="grid two">
      <section class="card">
        <div class="row between">
          <h2>Top Trends</h2>
          <span class="pill" id="trendCount">‚Äî</span>
        </div>
        <div id="trends" class="grid" style="margin-top:10px;"></div>
      </section>

      <section class="card">
        <div class="row between">
          <h2>This Week‚Äôs Shortlist</h2>
          <span class="pill">Buzzy-first</span>
        </div>

        <div class="kpi">
          <div><label>B2B Try</label><strong id="b2bTryN">‚Äî</strong></div>
          <div><label>Consumer Try</label><strong id="cTryN">‚Äî</strong></div>
          <div><label>Monitor</label><strong id="mTryN">‚Äî</strong></div>
        </div>

        <div class="split" style="margin-top:10px;">
          <div>
            <h3>B2B SaaS ‚Äî Try</h3>
            <div id="b2bTry" style="margin-top:6px;"></div>
            <div class="hr"></div>
            <h3>Consumer ‚Äî Try</h3>
            <div id="cTry" style="margin-top:6px;"></div>
          </div>
          <div>
            <h3>Monitor</h3>
            <div id="monitor" style="margin-top:6px;"></div>
            <div class="hr"></div>
            <div class="small">Tip: use Search + Min buzz to skim only the spikiest items.</div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" style="margin-top:14px;">
      <div class="row between">
        <h2>Most Discussed Apps/Tools</h2>
        <span class="pill" id="appCount">‚Äî</span>
      </div>
      <div id="apps" class="grid" style="margin-top:10px;"></div>
    </section>

    <div class="small" style="margin-top:12px;">
      Powered by <code>latest.json</code>. Host this folder on GitHub Pages. Replace the JSON weekly.
    </div>
  </main>

  <script>
    const state = { mode: "all", q: "", action: "all", sort: "buzz", minBuzz: 70, report: null, theme: "dark" };

    function escapeHtml(s){
      return (s||"").toString()
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function fmt(n){ return (n===0 || n) ? n : "‚Äî"; }

    function actionClass(a){
      if(a==="TRY") return "try";
      if(a==="MONITOR") return "mon";
      if(a==="IGNORE") return "ign";
      return "";
    }
    function actionPill(a){
      const cls = actionClass(a);
      return `<span class="pill ${cls}">${escapeHtml(a||"MONITOR")}</span>`;
    }
    function normPct(x){
      if(x==null || isNaN(x)) return "‚Äî";
      const v = Math.max(0, Math.min(1, x));
      return Math.round(v*100) + "%";
    }
    function safeFixed(x){
      if(x==null || isNaN(x)) return "‚Äî";
      return Number(x).toFixed(2);
    }

    function chipList(names){
      if(!names || !names.length) return `<span class="muted">None</span>`;
      return names.map(n => `<span class="pill" style="margin:4px 6px 0 0;">${escapeHtml(n)}</span>`).join("");
    }

    function renderEvidence(items){
      if(!items || !items.length) return `<div class="muted">No links</div>`;
      return `<ul>${
        items.slice(0,5).map(e => `<li><a href="${e.url}" target="_blank" rel="noopener">${escapeHtml(e.title||e.url)}</a> <span class="muted">(${escapeHtml(e.source||"")})</span></li>`).join("")
      }</ul>`;
    }

    function passesMode(app){
      if(state.mode==="all") return true;
      const cat = (app.category||"").toLowerCase();
      if(state.mode==="b2b") return cat.includes("b2b");
      if(state.mode==="consumer") return cat.includes("consumer");
      return true;
    }

    function passesAction(app){
      if(state.action==="all") return true;
      return (app.action||"MONITOR") === state.action;
    }

    function passesQuery(app){
      const q = state.q.trim().toLowerCase();
      if(!q) return true;
      const blob = [
        app.name, app.one_liner, app.category,
        ...(app.sentiment?.drivers?.positive||[]),
        ...(app.sentiment?.drivers?.negative||[]),
        ...(app.watchouts||[]),
        ...(app.try_plan_30min||[])
      ].join(" ").toLowerCase();
      return blob.includes(q);
    }

    function passesMinBuzz(app){
      const b = app.app_buzz_score ?? 0;
      return b >= state.minBuzz;
    }

    function sortApps(list){
      const m = state.mode;
      const fitField = (m==="consumer") ? "consumer_fit" : (m==="b2b") ? "b2b_fit" : null;

      if(state.sort==="buzz"){
        return list.sort((a,b)=> (b.app_buzz_score||0) - (a.app_buzz_score||0));
      }
      if(state.sort==="sent"){
        return list.sort((a,b)=> (b.sentiment?.net||0) - (a.sentiment?.net||0));
      }
      if(state.sort==="fit"){
        if(fitField){
          return list.sort((a,b)=> (b[fitField]||0) - (a[fitField]||0));
        }
        // All mode: average fit
        return list.sort((a,b)=> (((b.b2b_fit||0)+(b.consumer_fit||0))/2) - (((a.b2b_fit||0)+(a.consumer_fit||0))/2));
      }
      return list;
    }

    function renderTrends(){
      const root = document.getElementById("trends");
      const trends = (state.report?.top_trends || []).slice(0,10);
      document.getElementById("trendCount").textContent = `${trends.length} trends`;

      root.innerHTML = trends.map(t => `
        <div class="card soft">
          <div class="row between">
            <div style="font-weight:800;">${escapeHtml(t.topic||"")}</div>
            <span class="pill">Score <span class="score">${fmt(t.trend_score)}</span></span>
          </div>
          <div class="muted" style="margin-top:6px;">${escapeHtml(t.why_now||"")}</div>
          ${(t.implications && t.implications.length) ? `
            <div style="margin-top:8px;">
              <div class="small">Implications</div>
              <ul>${t.implications.slice(0,3).map(x=>`<li>${escapeHtml(x)}</li>`).join("")}</ul>
            </div>` : ""
          }
          ${(t.evidence && t.evidence.length) ? `
            <div style="margin-top:8px;">
              <div class="small">Evidence</div>
              ${renderEvidence(t.evidence)}
            </div>` : ""
          }
        </div>
      `).join("");
    }

    function renderShortlist(){
      const s = state.report?.shortlist || { b2b_try:[], consumer_try:[], monitor:[] };
      const b2b = s.b2b_try || [];
      const con = s.consumer_try || [];
      const mon = s.monitor || [];

      document.getElementById("b2bTryN").textContent = b2b.length;
      document.getElementById("cTryN").textContent = con.length;
      document.getElementById("mTryN").textContent = mon.length;

      document.getElementById("b2bTry").innerHTML = chipList(b2b);
      document.getElementById("cTry").innerHTML = chipList(con);
      document.getElementById("monitor").innerHTML = chipList(mon);
    }

    function renderApps(){
      const root = document.getElementById("apps");
      const all = (state.report?.apps || []);

      const filtered = all
        .filter(passesMode)
        .filter(passesAction)
        .filter(passesQuery)
        .filter(passesMinBuzz);

      const apps = sortApps(filtered).slice(0, 40);

      document.getElementById("counts").textContent = `${all.length} apps in report`;
      document.getElementById("appCount").textContent = `${apps.length} shown`;

      if(!apps.length){
        root.innerHTML = `<div class="muted">No apps match your filters. Try lowering ‚ÄúMin buzz‚Äù or switching Action to All.</div>`;
        return;
      }

      root.innerHTML = apps.map(a => {
        const sent = a.sentiment || {};
        const cat = a.category || "Unknown";
        const action = a.action || "MONITOR";

        return `
          <div class="card soft">
            <div class="row between">
              <div>
                <div class="row">
                  <div style="font-weight:900; font-size:15px;">${escapeHtml(a.name||"")}</div>
                  <span class="pill">${escapeHtml(cat)}</span>
                  ${actionPill(action)}
                </div>
                <div class="muted" style="margin-top:6px;">${escapeHtml(a.one_liner||"")}</div>
              </div>
              <div class="row">
                <span class="pill">Buzz <span class="score">${fmt(a.app_buzz_score)}</span></span>
                <span class="pill">B2B <span class="score">${fmt(a.b2b_fit)}</span></span>
                <span class="pill">Cons <span class="score">${fmt(a.consumer_fit)}</span></span>
              </div>
            </div>

            <div class="kpi">
              <div><label>Sentiment net</label><strong>${safeFixed(sent.net)}</strong></div>
              <div><label>Positive</label><strong>${normPct(sent.pos)}</strong></div>
              <div><label>Negative</label><strong>${normPct(sent.neg)}</strong></div>
            </div>

            <div class="split" style="margin-top:10px;">
              <div>
                <div class="small">Sentiment drivers</div>
                <div class="row" style="align-items:flex-start; margin-top:6px;">
                  <div style="flex:1; min-width: 240px;">
                    <div style="font-size:12px;">‚úÖ Positive</div>
                    <ul>${(sent.drivers?.positive||[]).slice(0,3).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || `<li class="muted">None</li>`}</ul>
                  </div>
                  <div style="flex:1; min-width: 240px;">
                    <div style="font-size:12px;">‚ö†Ô∏è Negative</div>
                    <ul>${(sent.drivers?.negative||[]).slice(0,3).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || `<li class="muted">None</li>`}</ul>
                  </div>
                </div>

                ${(a.watchouts && a.watchouts.length) ? `
                  <div style="margin-top:10px;">
                    <div class="small">Watchouts</div>
                    <ul>${a.watchouts.slice(0,3).map(x=>`<li class="danger">${escapeHtml(x)}</li>`).join("")}</ul>
                  </div>` : ""
                }
              </div>

              <div>
                <div class="small">Try plan (30 min)</div>
                <ul>${(a.try_plan_30min||[]).slice(0,4).map(x=>`<li>${escapeHtml(x)}</li>`).join("") || `<li class="muted">Add a try plan</li>`}</ul>

                <div style="margin-top:10px;">
                  <div class="small">Evidence</div>
                  ${renderEvidence(a.top_evidence)}
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");
    }

    function setMode(mode){
      state.mode = mode;
      document.getElementById("tabAll").classList.toggle("active", mode==="all");
      document.getElementById("tabB2B").classList.toggle("active", mode==="b2b");
      document.getElementById("tabConsumer").classList.toggle("active", mode==="consumer");
      renderApps();
    }

    function applyTheme(theme){
      state.theme = theme;
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("aiRadarTheme", theme);
    }
    function toggleTheme(){
      applyTheme(state.theme === "dark" ? "light" : "dark");
    }

    async function loadReport(){
      const res = await fetch("latest.json", { cache: "no-store" });
      const report = await res.json();
      state.report = report;

      const meta = document.getElementById("meta");
      meta.textContent = `Week ${report.week_start} ‚Üí ${report.week_end} ‚Ä¢ Sources: ${(report.sources||[]).join(", ")} ‚Ä¢ Generated: ${report.generated_at}`;

      renderTrends();
      renderShortlist();
      renderApps();
    }

    // Wire UI
    document.getElementById("tabAll").onclick = () => setMode("all");
    document.getElementById("tabB2B").onclick = () => setMode("b2b");
    document.getElementById("tabConsumer").onclick = () => setMode("consumer");

    document.getElementById("q").addEventListener("input", (e) => { state.q = e.target.value; renderApps(); });
    document.getElementById("actionSel").addEventListener("change", (e) => { state.action = e.target.value; renderApps(); });
    document.getElementById("sortSel").addEventListener("change", (e) => { state.sort = e.target.value; renderApps(); });
    document.getElementById("minBuzzSel").addEventListener("change", (e) => { state.minBuzz = parseInt(e.target.value, 10) || 0; renderApps(); });

    document.getElementById("themeBtn").onclick = toggleTheme;

    // Init theme from storage
    const savedTheme = localStorage.getItem("aiRadarTheme");
    applyTheme(savedTheme || "dark");

    loadReport().catch(err => {
      document.getElementById("meta").textContent = "Failed to load latest.json. Open console for details.";
      console.error(err);
    });
  </script>
</body>
</html>
